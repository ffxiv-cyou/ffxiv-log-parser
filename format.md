## 文件格式

文件格式:
```
| Header | Offset Table | Log entries |
```

文件头：
```
| 0 - 3 | 4 - 7 |
| begin |  end  |
```

- begin: 条目开始offset
- end: 条目结束offset

使用 end - begin 即可得到此文件有多少行 log。

偏移表：
```
|  0 - 3  |  4 - 7  | ...
| offset1 | offset2 | ...
```
偏移表中的数据个数与上面计算的行数一致。

- offset: 指示当前log的尾部偏移量。偏移量从第一个条目开始计算。

Log: 
```
|   0 - 3   | 4      | 5       | 6 - 7  |  8   |   ...  | N    |   ...   |
| timestamp | filter | channel | 0x0000 | 0x1f | Sender | 0x1f | Message |
```

每条Log以0x1F为分割线，将其分为三个部分：
- Log 头
  - timestamp: 发送时间戳
  - filter: 参见 LogFilter.csv
  - channel: 
- 发送者：可以为空
- 消息：消息内容

消息与发送者为带标记文本，详情见下方。

## 带标记文本

带标记文本是一种 UTF-8 文本与标记信息混排的文本。

标记信息格式如下：

```
| 0      | 1    | 2   | 3 ... | Len + 3 |
| Header | Type | Len | Data  | End     |
```

- Header: 标记头，始终为 0x02
- Type: 标记类型
- Len: 参数长度，包括最后的结束符
- Data: 参数
- End: 结束符，始终为 0x03

### 参数编码格式

由于此数据可以看作字符串，故中间不能出现0x00，否则会截断字符串。

根据已有数据分析，我们可知数据Dat以如下规则编码：
- 0x00-0xCE: 编码为 Dat + 1
- 0xCF-0xFF: 前面添加 0xF0, 形成 [0xF0, Dat]
- 0x0100-0xFFFF:
 - 若以00结尾：前面添加 0xF1，形成 [0xF1, Dat>>8]
 - 若不以00结尾：前面添加 0xF2，形成 [0xF2, Dat>>8, Dat&0xFF]
- 0x010000-0xFFFFFF:
 - 若中间没有0：前面添加 0xF6，形成 [0xF6, Dat>>16, Dat>>8, Dat&0xFF]
- 0x01000000-0xFFFFFF:
 - 若中间没有0：前面添加 0xFE，形成 [0xFE, Dat>>24, Dat>>16, Dat>>8, Dat&0xFF]

数据以大端序存储

### 0x12 图标

参数为 1 Byte.

目前已知的参数值有:

- 4f: 皇冠
- 4e: 豆芽
- 51: 锤子
- 59: 跨服的花
- 60: 豆花

### 0x13 设置颜色

参数有两种类型：

- 4 Byte：设置颜色，格式为ARGB
- 1 Byte: EC，重置颜色

示例:

```
[FE FF F3 F3 F3]: 白色: F3F3F3
[FE FF FA 89 B6]: 紫色: FA89B6
[EC]: 重置颜色
```

此格式已经很少见到了，基本上使用后面的样式设定代替。

### 0x27 链接到目标

第一个参数为目标类型，当前已知的有：

#### 0x00 玩家

其余参数未知

#### 0x02 物品

- 参数1：物品ID。若为HQ则 +1,000,000
- 其余参数未知

```
[03 f2 16 c1 02 01]: // 16c1 = 物品 ID
[03 13 02 01]: // 雷之晶簇(18, 0x12)
[03 f6 0f d3 e0 02 01]: // 艾布拉纳赛黄晶 HQ. 0x0fd3e0 = 物品ID + 1000000
```

#### 0x03 地图

- 参数1：Territory ID, Map ID
- 参数2：X坐标 * 1000, int32 类型
- 参数3：Y坐标 * 1000, int32 类型
- 其余参数未知

```
[04 fe 03 bd 02 b8 fe ff f6 48 c6 f6 0c aa 76 ff 01] // 萨维奈岛 3x ( 8.7 , 38.0 )
[04 fe 03 32 01 f0 fe ff fc 1d 61 fe ff fe d2 05 ff 01] // 黑风海 ( 16.3 , 19.9 ) Z:-2.8
```

#### 0x05 成就

- 参数1: 成就ID
- 其余参数未知

#### 0x07 招募板

（当前有XXX个队伍正在招募队员）

参数未知。

```
[08 01 01 01 ff 01]
```

#### 0x08 Buff 状态

- 参数1: Buff ID，参见 Status.csv
- 其余参数未知

```
[9 f2 4 b4 1 1 ff 2 20] // 醒梦
[9 f2 4 a9 1 1 ff 2 20] // 雪仇
```

#### 0x09 队员招募

其余参数未知

```
[0a f6 02 e0 e6 01 f3 01]
```

#### 0xce 结束链接

其余参数未知

```
[cf 1 1 1 ff 1]
```

### 0x2E 定型文

有两个参数: 

- 第一个参数是组别
- 第二个参数是ID

其对应内容请参考 Completion.csv 这个表。

示例：

```
- [04 f2 01 9c]: 嗯……
  - 组别: 03
  - ID: 0x19c = 412
```

可参考对应表: [Github gist](https://gist.github.com/3735943886/fe5ac8012ffe37c9dfa180b1944b513c)

### 0x48 样式设定

只有一个参数
- 参数为0时重置样式
- 参数为其他时设定样式

样式内容参见 UIColor.csv

```
[f2 01 f4] 链接图标参数(橙色) 
[f2 02 25] 普通物体（看上去像是白色）
[f2 02 27] 绿色装备
[f2 02 29] 蓝色装备
[f2 02 05] Buff 图标（蓝色） 
[f2 02 06] Debuff 图标 （红色）
[f2 02 3b] 量谱
[01] 重置样式
```

### 0x49 样式设定

只有一个参数
- 参数为0时重置样式
- 参数为其他时设定样式

样式内容参见 UIColor.csv

```
[f2 01 f5] 链接图标参数 (橙色) 
[f2 02 26] 部分物体链接前也可见参数（看上去像是白色）
[f2 02 28] 绿色装备
[f2 02 2a] 蓝色装备
[f2 02 3c] 量谱
[01] 重置样式
```
